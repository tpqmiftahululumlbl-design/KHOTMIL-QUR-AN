<!doctype html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laporan Keuangan Khotmil Qur'an</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

<style>body{font-family:'Tajawal',sans-serif}</style>
</head>

<body class="bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 min-h-screen p-4">

<div class="max-w-6xl mx-auto space-y-6">

<!-- HEADER -->
<div class="bg-white rounded-2xl shadow p-6 text-center">
<h1 class="text-2xl sm:text-3xl font-bold text-emerald-700">
ðŸ“– LAPORAN KEUANGAN KHOTMIL QUR'AN KE-20
</h1>
<p class="text-gray-600">TPQ MIFTAHUL ULUM</p>
<p class="text-gray-500">Pondok Pesantren Al-Mubarok Lanbulan</p>

<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6">
<div class="bg-green-500 text-white rounded-xl p-4">
<p>Total Pemasukan</p><div id="totalMasuk" class="text-xl font-bold">Rp 0</div>
</div>
<div class="bg-red-500 text-white rounded-xl p-4">
<p>Total Pengeluaran</p><div id="totalKeluar" class="text-xl font-bold">Rp 0</div>
</div>
<div class="bg-blue-500 text-white rounded-xl p-4">
<p>Saldo</p><div id="saldo" class="text-xl font-bold">Rp 0</div>
</div>
</div>
</div>

<!-- FORM -->
<div class="bg-white rounded-2xl shadow p-6">
<h2 class="font-bold mb-4">Tambah Transaksi</h2>

<form id="form" class="space-y-4">
<div class="grid sm:grid-cols-2 gap-4">
<input id="tanggal" type="date" required class="border p-2 rounded">
<select id="kategori" required class="border p-2 rounded">
<option value="">Pilih Kategori</option>
<option>Operasional</option><option>Infaq</option><option>Konsumsi</option>
<option>Dekorasi</option><option>Dokumentasi</option><option>Hadiah</option><option>Lain-lain</option>
</select>
</div>

<input id="keterangan" required placeholder="Keterangan" class="border p-2 rounded w-full">

<div class="grid sm:grid-cols-2 gap-4">
<input id="masuk" type="number" placeholder="Pemasukan" class="border p-2 rounded">
<input id="keluar" type="number" placeholder="Pengeluaran" class="border p-2 rounded">
</div>

<button class="bg-emerald-600 text-white w-full py-2 rounded font-bold">ðŸ’¾ Simpan</button>
</form>
</div>

<!-- GRAFIK -->
<div class="bg-white rounded-2xl shadow p-6">
<h2 class="font-bold mb-4">Grafik Keuangan</h2>
<canvas id="grafik" height="120"></canvas>
</div>

<!-- TABEL -->
<div class="bg-white rounded-2xl shadow p-6">
<div class="flex flex-wrap gap-3 mb-4">
<button onclick="exportExcel()" class="bg-blue-600 text-white px-4 py-2 rounded">Excel</button>
<button onclick="exportWord()" class="bg-indigo-600 text-white px-4 py-2 rounded">Word</button>
</div>

<div class="overflow-x-auto">
<table class="w-full text-sm">
<thead class="bg-gray-100">
<tr>
<th>Tanggal</th><th>Kategori</th><th>Keterangan</th>
<th class="text-right">Masuk</th><th class="text-right">Keluar</th>
<th class="text-right">Saldo</th>
</tr>
</thead>
<tbody id="tabel"></tbody>
</table>
</div>
</div>

</div>

<script>
const API_URL=https://script.google.com/macros/s/AKfycbwuLZbtIED64GC6MzsF09KmGMO8WmjChTNEFxAykg8gG8jR7L215PTBfwOJPdAjdJOp/exec;
let data=[],chart=null;
const $=i=>document.getElementById(i);

$("tanggal").value=new Date().toISOString().split("T")[0];

function rupiah(n){return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(n);}

async function loadData(){
 const r=await fetch(API_URL); const raw=await r.json();
 data=raw.slice(1).map(x=>({tgl:x[0],kat:x[1],ket:x[2],masuk:+x[3],keluar:+x[4]}));
 render();
}

function render(){
 $("tabel").innerHTML=""; let m=0,k=0,s=0;
 const lbl=[],am=[],ak=[];
 data.forEach(d=>{
  m+=d.masuk;k+=d.keluar;s+=d.masuk-d.keluar;
  lbl.push(d.tgl);am.push(d.masuk);ak.push(d.keluar);
  $("tabel").innerHTML+=`
   <tr class="border-b">
   <td>${d.tgl}</td><td>${d.kat}</td><td>${d.ket}</td>
   <td class="text-right text-green-600">${rupiah(d.masuk)}</td>
   <td class="text-right text-red-600">${rupiah(d.keluar)}</td>
   <td class="text-right font-semibold">${rupiah(s)}</td></tr>`;
 });
 $("totalMasuk").textContent=rupiah(m);
 $("totalKeluar").textContent=rupiah(k);
 $("saldo").textContent=rupiah(m-k);
 drawChart(lbl,am,ak);
}

function drawChart(l,m,k){
 const ctx=$("grafik").getContext("2d");
 if(chart)chart.destroy();
 chart=new Chart(ctx,{type:"line",
 data:{labels:l,datasets:[
 {label:"Masuk",data:m,fill:true,borderColor:"#22c55e",backgroundColor:"rgba(34,197,94,.2)",tension:.4},
 {label:"Keluar",data:k,fill:true,borderColor:"#ef4444",backgroundColor:"rgba(239,68,68,.2)",tension:.4}
 ]}});
}

$("form").onsubmit=async e=>{
 e.preventDefault();
 await fetch(API_URL,{method:"POST",body:JSON.stringify({
  tgl:$("tanggal").value,kat:$("kategori").value,ket:$("keterangan").value,
  masuk:+$("masuk").value||0,keluar:+$("keluar").value||0
 })});
 e.target.reset(); $("tanggal").value=new Date().toISOString().split("T")[0];
 loadData();
};

function exportExcel(){
 const ws=XLSX.utils.json_to_sheet(data);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Laporan");
 XLSX.writeFile(wb,"laporan.xlsx");
}

function exportWord(){
 const t=new Date().toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});
 let s=0,html=`<h3 align=center>LAPORAN KEUANGAN KHOTMIL QUR'AN KE-20</h3>
 <table border=1 width=100% cellpadding=5><tr>
 <th>Tgl</th><th>Kat</th><th>Ket</th><th>Masuk</th><th>Keluar</th><th>Saldo</th></tr>`;
 data.forEach(d=>{s+=d.masuk-d.keluar;
 html+=`<tr><td>${d.tgl}</td><td>${d.kat}</td><td>${d.ket}</td>
 <td>${rupiah(d.masuk)}</td><td>${rupiah(d.keluar)}</td><td>${rupiah(s)}</td></tr>`;});
 html+=`</table><br><br><div align=right>Lanbulan : ${t}<br><br>Bendahara Acara<br><b>UST. ABU BAKAR ASSHIDDIQ</b></div>`;
 const b=new Blob(['\ufeff',html],{type:'application/msword'});
 const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download="laporan.doc";a.click();
}

loadData();
</script>
</body>
</html>

